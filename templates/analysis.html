{% extends "_base.html" %}

{% block content %}
<div class="page-header">
    <h1>HIV-TRACE Results</h1>
</div>

<div class="row">
    <div class="tabbable">
    <ul class="nav nav-tabs" id="top_level_tab_container">
      <li class="active" id="main-tab"><a href="#trace-results" data-toggle="tab">Network</a></li>
      <li class="disabled" id="lanl-result-tab"><a href="#lanl-trace-results" data-toggle="tab">Network + DB</a></li>
      <li class="disabled" id="graph-tab"><a href="#trace-graph" data-toggle="tab">Graph</a></li>
      <li class="disabled" id="clusters-tab"><a href="#trace-clusters" data-toggle="tab">Clusters</a></li>
      <li class="disabled" id="nodes-tab"><a href="#trace-nodes" data-toggle="tab">Nodes</a></li>
      <li class="disabled" id="attributes-tab"><a href="#trace-attributes" data-toggle="tab">Attributes</a></li>
      <li class="disabled"><a href="#trace-settings" data-toggle="tab">Settings</a></li>
    </ul>

    <div class="tab-content">
      <div id="trace-results" class="tab-pane active">
        <!-- Warning bar -->
        <div class="row" style="margin-top: 10px; margin-bottom: 10 px;">
          <div class="col-lg-12">
            <div class="alert alert-info" id="main-warning" style="display:none;"></div>
          </div>
        </div>

        <div class="row">
          <div class="col-lg-9">
            <div class="nav-trace">
              <div class="input-group input-group-sm" id="network_ui_bar">

                <!-- UI Bar -->
                <div class="nav-trace">
                  <div class="input-group input-group-sm" id="network_ui_bar">
                    <div class="input-group-btn" id="network_ui_bar_button_group"></div>
                    <span class="input-group-btn">
                      <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" id="network_ui_bar_cluster_operations_button">Clusters <span class="caret"></span></button>
                      <ul class="dropdown-menu" role="menu" id="network_ui_bar_cluster_operations_container"></ul>
                    </span>
                    <div class="input-group-btn">
                      <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" id="network_ui_bar_attributes_label">Attribute <span class="caret"></span></button>
                      <ul class="dropdown-menu" role="menu" id="network_ui_bar_attributes"></ul>
                    </div>
                    <input type="text" class="form-control" placeholder="Search for nodes" id="network_ui_bar_filter">
                  </div>
                </div>

                <!-- Main SVG -->
                <div id="network_tag">
                  <div class="my_progress">
                    <div class="progress-bar progress-bar-striped disabled" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                      Please load a network
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>

        </div>


        <div class="row">
          <div class="col-lg-9">
            <p id="network_status_string" class="text-info"></p>
          </div>
          <div id="network_ui_bar_aux_svg_holder" class="row style = " margin-left:="" 5px="" ''=""></div>
        </div>

      </div>


    <div id="trace-graph" class="tab-pane">
      <div class="row">
        <div class="col-lg-6">
          <p class="lead"> Graph Statistics </p>
          <table class="table table-striped table-condensed" id="graph_summary_table">
          </table>
        </div>
        <div class="col-lg-6">
          <p id="histogram_label" class="lead"></p>
          <div class="row" id="histogram_tag" style="margin-left: 5px">
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <p class="lead"> Misc. </p>
        <div id="fasta-export" class="row hivtrace-download-button">
          {% set alignment_url = url_for('analysis_alignment', analysis_uuid=analysis_uuid) %}
          <a href="{{ alignment_url }}" class="btn btn-default btn-sm">
            <span class="fa fa-download"></span> HXB2 Alignment
          </a>
        </div>
      </div>
    </div>

    <div id="lanl-trace-results" class="tab-pane">
      <div class="row" style="margin-top: 10px; margin-bottom: 10 px;">
        <div class="col-lg-12">
          <div class="alert alert-info" id="lanl-main-warning" style="display:none;">
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-12">
          <div class="row">
            <div class="input-group input-group-sm" id="lanl_network_ui_bar">
              <span class="input-group-btn">
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" id="lanl_network_ui_bar_cluster_operations_button">Clusters <span class="caret"></span></button>
              <ul class="dropdown-menu" role="menu" id="lanl_network_ui_bar_cluster_operations_container"></ul>
              </span>
              <div class="input-group-btn">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" id="lanl_network_ui_bar_attribute_label">Attribute <span class="caret"></span></button>
                <ul class="dropdown-menu" role="menu" id="lanl_network_ui_bar_attributes"></ul>
              </div>
              <input type="text" class="form-control" placeholder="search" id="lanl_network_ui_bar_search">
            </div>
          </div>
          <div class="row" id="lanl-network_tag">
            <div class="my_progress">
              <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                Loading the network...
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-9">
          <p id="lanl-network_status_string" class="text-info"></p>
        </div>
      </div>
    </div>

    <div id="trace-clusters" class="tab-pane">
      <div class="row">
        <div class="col-lg-12">
          <span class="pull-right" id="cluster-table-export"> </span>
          <p class="lead"> Clusters (connected components) </p>
          <table class="table table-striped table-condensed table-hover" id="cluster_table">
          </table>
        </div>
      </div>
    </div>

    <div id="trace-nodes" class="tab-pane">
      <div class="row">
        <div class="col-lg-12">
          <span class="pull-right" id="node-table-export"> </span>
          <p class="lead"> Nodes </p>
          <table class="table table-striped table-condensed table-hover" id="node_table">
          </table>
        </div>
      </div>
    </div>

    <div id="trace-attributes" class="tab-pane">
      <div class="row">
        <div class="nav-trace">
          <div class="input-group input-group-sm" id="network_ui_bar_attributes_container">
            <span class="input-group-btn">
                          Categorical
                          <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" id="network_ui_bar_attributes_cat_label">Attributes <span class="caret"></span></button>
            <ul class="dropdown-menu" role="menu" id="network_ui_bar_attributes_cat"></ul>
            </span>
          </div>
        </div>
        <div class="col-lg-6">
          <div id="network_ui_bar_aux_svg_holder" class="row style = margin-left: 5px">
                  </div>
              </div>
               <div class="col-lg-6 ">
                   <span class="pull-right" id="network_ui_bar_attribute_table_export"> </span>
                   <table class="table table-striped table-condensed table-hover" id="network_ui_bar_attribute_table">
                   </table>
              </div>
          </div>
      </div>


    </div>
  </div>
</div>

<img class="hidden" id="chart-image" />
<canvas class="hidden" id="chart-canvas"></canvas>
{% endblock %}

{% block js %}
<script src="/static/lib/datamonkey/datamonkey.js"></script>
<script src="/static/lib/datamonkey/helpers.js"></script>
<script src="/static/js/hivtrace.js"></script>
<script src="/static/js/misc.js"></script>
<script src="/static/js/histogram.js"></script>
<script src="/static/js/clusternetwork.js"></script>

<script type="text/javascript">

var network_container     = '#network_tag',
    network_status_string = '#network_status_string',
    network_warning       = '#main-warning',
    histogram_tag         = '#histogram_tag',
    histogram_label       = '#histogram_label',
    button_bar_prefix     = 'network_ui_bar',
    csvexport_label       = '#csvexport',
    fasta_export_label    = '#fasta-export',
    filter_edges_toggle   = '#network_ui_bar_toggle_filter_edges',
    graph_summary_tag     = '#graph_summary_table',
    cluster_table         = '#cluster_table',
    parent_container      = '#trace-results',
    node_table            = '#node_table';

var init = function(data) {
  var graph = data.trace_results;
  var attributes = null;
  var user_graph = new datamonkey.hivtrace.cluster_network_graph(graph, network_container, network_status_string, network_warning, button_bar_prefix, attributes, filter_edges_toggle, cluster_table, node_table, parent_container);
  datamonkey.hivtrace.histogram(graph, histogram_tag, histogram_label);
  datamonkey.hivtrace.graph_summary (graph, graph_summary_tag);
  d3.select ("#graph-tab").classed ("disabled", false);
  d3.select ("#clusters-tab").classed ("disabled", false);
  d3.select ("#nodes-tab").classed ("disabled", false);
  d3.select ("#attributes-tab").classed ("disabled", false);
  datamonkey.hivtrace.export_table_to_text ("#cluster-table-export", cluster_table);
  datamonkey.hivtrace.export_table_to_text ("#node-table-export", node_table);
  $("#main-tab a[data-toggle='tab']").on ("shown.bs.tab", function (e) {
        if (user_graph.needs_an_update) {
            user_graph.update(false, 0.5);
        }
  });
  $("#clusters-tab a[data-toggle='tab']").on ("shown.bs.tab", function (e) {
        user_graph.update_volatile_elements (d3.select (cluster_table));
  });
  $("#nodes-tab a[data-toggle='tab']").on ("shown.bs.tab", function (e) {
        user_graph.update_volatile_elements (d3.select (node_table));
  });
  if(data.lanl_trace_results) {
    // Only if the comparison was done
    var lanl_network_container     = '#lanl-network_tag',
        lanl_network_status_string = '#lanl-network_status_string',
        lanl_network_warning       = '#lanl-main-warning',
        lanl_histogram_tag         = '#lanl-histogram_tag',
        lanl_histogram_label       = '#lanl-histogram_label',
        lanl_csvexport_label       = '#lanl-csvexport',
        lanl_button_bar_prefix     = 'lanl_network_ui_bar';
    d3.select ("#lanl-result-tab").classed ("disabled", false);
    var lanl_graph = data.lanl_trace_results;
    var lanl_graph_rendered = new datamonkey.hivtrace.cluster_network_graph(lanl_graph, lanl_network_container, lanl_network_status_string, lanl_network_warning, lanl_button_bar_prefix, attributes, filter_edges_toggle, null, null, parent_container);
  }
}

$(document).ready(function() {
    {% autoescape false %}
    init(JSON.parse('{{ results }}'));
    {% endautoescape %}
});
</script>
{% endblock %}
